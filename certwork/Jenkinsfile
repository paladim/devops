pipeline {
    parameters {
        password (name: 'AWS_ACCESS_KEY_ID')
        password (name: 'AWS_SECRET_ACCESS_KEY')
    }

    agent any
    stages {
        stage("Deploy") {
            // agent {
            //     docker {
            //         image "jenkins-agent:latest"
            //         args '-v /var/run/docker.sock:/var/run/docker.sock'
            //         reuseNode true
            //         label "jenkins-agent"
            //     }
            // }
            steps {
                echo "Build start"
                sh "[ ! -d /opt/app1 ] && git clone https://github.com/paladim/devops /opt/app1 || true"
                sh "git -C /opt/app1 pull"
                sh "[ ! -d /opt/app1/certwork/keys ] && mkdir -p /opt/app1/certwork/keys || true"
                sh "[ ! -f /opt/app1/certwork/keys/ssh_key ] && ssh-keygen -t rsa -N '' -f /opt/app1/certwork/keys/ssh_key || true"
                sh "terraform -chdir=/opt/app1/certwork/terraform init -var='AWS_ACCESS_KEY_ID=${params.AWS_ACCESS_KEY_ID}' -var='AWS_SECRET_ACCESS_KEY=${params.AWS_SECRET_ACCESS_KEY}'"
                sh "terraform -chdir=/opt/app1/certwork/terraform plan -var='AWS_ACCESS_KEY_ID=${params.AWS_ACCESS_KEY_ID}' -var='AWS_SECRET_ACCESS_KEY=${params.AWS_SECRET_ACCESS_KEY}'"
                sh "terraform -chdir=/opt/app1/certwork/terraform apply -var='AWS_ACCESS_KEY_ID=${params.AWS_ACCESS_KEY_ID}' -var='AWS_SECRET_ACCESS_KEY=${params.AWS_SECRET_ACCESS_KEY}'"
            }
        }
    }
}
